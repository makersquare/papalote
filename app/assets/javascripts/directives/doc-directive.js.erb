// This directive is used for doc-view.html
// 
app.directive('docDirective', ['Doc', '$route', function(Doc, $route) {
  return {
    templateUrl: "<%= asset_path('assets/templates/doc-textarea.html') %>",
    scope: false,
    // link contains all the functions that manipulate the DOM
    link: function(scope, element, attrs) {
      element.bind("keyup", function(event) {
        scope.doc.content = editor.getValue();
        channel.trigger('change_doc',scope.doc);
      });

      scope.changeTheme = function() {
        editor.setTheme("ace/theme/" + scope.theme);
      };

      var dispatcher = new WebSocketRails(window.location.host+'/websocket');
      var channel = dispatcher.subscribe($route.current.params.id);
    
      var loadFile = function(data) {
        editor = ace.edit("editor");
        editor.setTheme("ace/theme/twilight");
        editor.getSession().setTabSize(2);
        if (data !== undefined) {
          setMode(data);
        }
      };

      var setMode = function(data) {
        if (data.name.slice(data.name.indexOf('.')+1) === 'js') {
          var JavaScriptMode = require("ace/mode/javascript").Mode;
          editor.getSession().setMode(new JavaScriptMode());
        } else if (data.name.slice(data.name.indexOf('.')+1) === 'rb') {
          var RubyMode = require("ace/mode/ruby").Mode;
          editor.getSession().setMode(new RubyMode());
        }
      };

      if ($route.current.params.id) {
        scope.doc = Doc.get({id: $route.current.params.id}, function(data) {
          loadFile(data);
          editor.setValue(data.content);
          editor.clearSelection();
        });
      } else {
        scope.test = Doc.get({id: 1}, function(data) {
          loadFile();
          editor.setValue("");
        });
      }

      channel.bind('change_doc',function(data) {
        var cursor = editor.getCursorPosition();
        editor.session.doc.setValue(data.content);
        editor.selection.moveCursorTo(cursor.row, cursor.column);
        editor.clearSelection();
        scope.doc.content = data.content;
      });
    }
  };
}]);